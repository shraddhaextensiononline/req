{% extends 'base.html' %}
{% block content %}
  <div class="grid mt-4">
    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
        <h2 style="margin:0;">{{ dept_title or current_user.department.value }} Requirements</h2>
        {% if not public_view %}
          <a class="btn primary" href="{{ url_for('requirements.create_requirement') }}">New Requirement</a>
        {% else %}
          <a class="btn primary" href="{{ url_for('requirements.create_requirement_public', dept=dept_key) }}">New Requirement</a>
        {% endif %}
      </div>
      <form method="get" class="grid" style="grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px; margin-bottom:12px;">
        <div>
          <label for="staff">Staff</label>
          <select id="staff" name="staff">
            <option value="">All</option>
            {% for s in staff_list %}
              <option value="{{ s }}" {% if filter_staff==s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="customer">Customer</label>
          <input id="customer" name="customer" type="text" value="{{ filter_customer or '' }}" placeholder="Search name"/>
        </div>
        <div>
          <label for="status">Status</label>
          <select id="status" name="status">
            <option value="open" {% if filter_status=='open' %}selected{% endif %}>Open (New + In Progress)</option>
            <option value="new" {% if filter_status=='new' %}selected{% endif %}>New</option>
            <option value="in_progress" {% if filter_status=='in_progress' %}selected{% endif %}>In Progress</option>
            <option value="fulfilled" {% if filter_status=='fulfilled' %}selected{% endif %}>Fulfilled</option>
            <option value="all" {% if filter_status=='all' %}selected{% endif %}>All</option>
          </select>
        </div>
        <div style="display:flex; align-items:flex-end; gap:8px;">
          <button class="btn primary" type="submit">Apply</button>
          <a class="btn" href="{{ url_for('requirements.dashboard') }}">Reset</a>
        </div>
      </form>
      {% if items %}
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Customer</th>
              <th>Staff</th>
              <th>Status</th>
              <th>Created</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for item in items %}
              <tr>
                <td>{{ item.id }}</td>
                <td>{{ item.customer_name }}</td>
                <td>{{ item.staff_name }}</td>
                <td><span class="badge">{{ item.status.value }}</span></td>
                <td>{{ item.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                {% if public_view %}
                  {% if current_user.is_authenticated and current_user.is_admin %}
                    <td><a class="btn" href="{{ url_for('requirements.detail', req_id=item.id) }}">Open</a></td>
                  {% else %}
                    <td><a class="btn" href="{{ url_for('requirements.public_detail', dept=dept_key, req_id=item.id) }}">Open</a></td>
                  {% endif %}
                {% else %}
                  <td><a class="btn" href="{{ url_for('requirements.detail', req_id=item.id) }}">Open</a></td>
                {% endif %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div style="color:var(--muted);">No requirements yet. Create the first one.</div>
      {% endif %}
    </div>
  </div>
{% endblock %}


